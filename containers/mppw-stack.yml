version: "3.8"
services:

  mppw:
    image: ascc/mppw:${MPPW_VERSION:-dev}
    restart: unless-stopped
    environment:
      MPPW_ADMIN_USERNAME: ${MPPW_ADMIN_USERNAME:-}
      MPPW_ADMIN_PASSWORD: ${MPPW_ADMIN_PASSWORD:-}
      MONGODB_URL: ${MONGODB_URL:-mongodb://mongodb/mppw?authSource=admin&tls=true&tlsAllowInvalidCertificates=true}
      MONGODB_ADMIN_USERNAME: ${MONGODB_ADMIN_USERNAME:-admin}
      MONGODB_ADMIN_PASSWORD: ${MONGODB_ADMIN_PASSWORD}

  mongodb:
    image: ascc/mppw-mongodb:${MPPW_VERSION:-dev}
    restart: unless-stopped
    volumes:
      - certificates:/etc/certificates
      - data_db:/data/db
      - data_configdb:/data/configdb
    ports:
      - "${MONGODB_EXTERNAL_PORT:-27017}:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_ADMIN_USERNAME:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_ADMIN_PASSWORD:?MONGODB_ADMIN_PASSWORD is required.}
      MONGO_INITDB_DATABASE: admin
      MONGO_INITRS_CONFIG: '{ "_id": "mppw0", "version": 1,  "members": [{ "_id": 0, "host": "mongodb:27017"}] }'
      MONGO_INITRS_TLS: 1
    command: ["mongod", "--tlsMode", "preferTLS", "--tlsCertificateKeyFile", "/etc/certificates/mongodb/key-cert.pem", "--replSet", "mppw0", "--keyFile", "/etc/certificates/mongodb/root-password-keyfile.key"]

  nginx:
    image: ascc/mppw-nginx:${MPPW_VERSION:-dev}
    restart: unless-stopped
    volumes:
      - certificates:/etc/certificates
    ports:
      - 80:80
      - 443:443
    environment:
      PROXY_PASS: http://mppw:8000

volumes:
  data_db:
  data_configdb:
  certificates:
