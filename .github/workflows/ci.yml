name: CI

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  lint-and-syntax:
    name: Lint + syntax
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python (for syntax check)
        uses: actions/setup-python@v5
        with:
          python-version: "3.8"

      # --- Syntax check ---
      - name: Python syntax check (compileall)
        run: |
          python -m compileall -q .

      # --- Lint ---
      - name: Install ruff
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Ruff lint
        run: |
          ruff check .

  tests:
    name: Poetry tests
    runs-on: ubuntu-latest

    env:
      HAS_GITLAB_KEY: ${{ secrets.GITLAB_SSH_PRIVATE_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---- Guard: skip cleanly if no secret ----
      - name: Skip tests if GitLab SSH key is missing
        if: env.HAS_GITLAB_KEY == ''
        run: |
          echo "GitLab SSH key not available â€” skipping tests."

      # ---- SSH setup ----
      - name: Add SSH key for GitLab
        if: env.HAS_GITLAB_KEY != ''
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.GITLAB_SSH_PRIVATE_KEY }}

      - name: Trust GitLab host key
        if: env.HAS_GITLAB_KEY != ''
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H gitlab.com >> ~/.ssh/known_hosts

      - name: Init submodules
        if: env.HAS_GITLAB_KEY != ''
        run: |
          git submodule update --init --recursive

      # ---- Python + Poetry ----
      - name: Set up Python
        if: env.HAS_GITLAB_KEY != ''
        uses: actions/setup-python@v5
        with:
          python-version: "3.8"

      - name: Install Poetry
        if: env.HAS_GITLAB_KEY != ''
        run: |
          python -m pip install --upgrade pip
          pip install "poetry>=1.6,<3.0"

      - name: Install dependencies
        if: env.HAS_GITLAB_KEY != ''
        run: |
          poetry install

      - name: Run tests
        if: env.HAS_GITLAB_KEY != ''
        run: |
          poetry run pytest -q
